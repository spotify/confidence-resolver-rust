name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  # Rust Components
  confidence-resolver:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Confidence Resolver (Rust)
      targets: confidence-resolver.test,confidence-resolver.lint

  wasm-msg:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: WASM Message (Rust)
      targets: wasm-msg.test,wasm-msg.lint

  wasm-rust-guest:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: WASM Rust Guest
      targets: wasm-rust-guest.build,wasm-rust-guest.lint
      upload-artifact: true

  cloudflare-resolver:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Cloudflare Resolver (Rust)
      targets: confidence-cloudflare-resolver.lint

  # OpenFeature Providers
  openfeature-js:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: OpenFeature Provider (JS)
      targets: openfeature-provider-js.test,openfeature-provider-js.build

  openfeature-java:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: OpenFeature Provider (Java)
      targets: openfeature-provider-java.test,openfeature-provider-java.build

  # Integration Tests (Host Examples)
  node-host:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Node.js Host Integration
      targets: node-host.test

  java-host:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Java Host Integration
      targets: java-host.test

  go-host:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Go Host Integration
      targets: go-host.test

  python-host:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with:
      job-name: Python Host Integration
      targets: python-host.test

  # Summary job that depends on all others
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      - confidence-resolver
      - wasm-msg
      - wasm-rust-guest
      - cloudflare-resolver
      - openfeature-js
      - openfeature-java
      - node-host
      - java-host
      - go-host
      - python-host
    if: always()
    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-module
          path: artifacts

      - name: Check job statuses
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Component Status" >> $GITHUB_STEP_SUMMARY
          echo "- Confidence Resolver: ${{ needs.confidence-resolver.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- WASM Message: ${{ needs.wasm-msg.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- WASM Rust Guest: ${{ needs.wasm-rust-guest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cloudflare Resolver: ${{ needs.cloudflare-resolver.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenFeature JS: ${{ needs.openfeature-js.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenFeature Java: ${{ needs.openfeature-java.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node Host: ${{ needs.node-host.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Java Host: ${{ needs.java-host.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Go Host: ${{ needs.go-host.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Host: ${{ needs.python-host.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### WASM Artifact" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.confidence-resolver.result != 'success' ||
          needs.wasm-msg.result != 'success' ||
          needs.wasm-rust-guest.result != 'success' ||
          needs.cloudflare-resolver.result != 'success' ||
          needs.openfeature-js.result != 'success' ||
          needs.openfeature-java.result != 'success' ||
          needs.node-host.result != 'success' ||
          needs.java-host.result != 'success' ||
          needs.go-host.result != 'success' ||
          needs.python-host.result != 'success'
        run: exit 1
